<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for server/server.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">server/</a> server.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">51.72% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>30/58</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">50% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>3/6</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">38.46% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>10/26</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">50.88% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>29/57</span>
      </div>
    </div>
  </div>
  <div class='status-line medium'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112</td><td class="line-coverage quiet"><span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">const nodemailer = require("nodemailer");
&nbsp;
exports = {  
    onAppInstallCallback:  function(payload) <span class="fstat-no" title="function not covered" >{</span>
<span class="cstat-no" title="statement not covered" >        console.log("on app install called " , payload);</span>
        const options = <span class="cstat-no" title="statement not covered" >{</span>
            headers :{
                Authorization:"Bearer &lt;%= iparam.freshteam_api_key %&gt;",
                accept: "application/json",
            }
        }
<span class="cstat-no" title="statement not covered" >        $request.get("https://&lt;%= iparam.freshteam_subdomain %&gt;.freshteam.com/api/employees", options).then(function(data) <span class="fstat-no" title="function not covered" >{</span></span>
<span class="cstat-no" title="statement not covered" >           if(data.status == 200)</span>
<span class="cstat-no" title="statement not covered" >               renderData();</span>
        },
        function(error) <span class="fstat-no" title="function not covered" >{</span>
<span class="cstat-no" title="statement not covered" >           renderData({message:`Domain Validation failed!!! , ${error}`});  </span>
        });
    },
    onNewHireCreateCallback: function(payload) {
        //console.log("new hire create called " , JSON.stringify(payload));
        let transporter = nodemailer.createTransport({
            host: 'smtp.gmail.com',
            port: 465,
            secure: true, // use SSL
            auth: { 
              user:payload.iparams.email, 
              pass:payload.iparams.email_passw,
           },
        });
        let newHireDesignation = payload.data.newhire.designation;
        $db.get("allSavedRolesTemplates").then (
          function(data) {
              let {savedRolesTemplate} = data;
                const matchedRole = (savedRole) =&gt; savedRole.role === newHireDesignation;
                let matchedRoleIndex = savedRolesTemplate.findIndex(matchedRole);
                <span class="missing-if-branch" title="else path not taken" >E</span>if(matchedRoleIndex != -1){
                    let options = {
                      from: payload.iparams.email,
                      to:payload.data.actor.email,
                      subject: savedRolesTemplate[matchedRoleIndex].subject,
                      text: savedRolesTemplate[matchedRoleIndex].body,
                    };
                    transporter.sendMail(options, function(error, info){
                      if (!error) {
                        console.log("email sent successfully " , info.response , options);
                        $db.get("allSentMailLogs").then (
                          function(data) {
                          let mails = data.sentMailLogs;
                          let today = new Date().toLocaleString();
                          mails.push({ role:savedRolesTemplate[matchedRoleIndex].role ,email:payload.data.actor.email,status_msg:"Email sent successfully",  sent:true ,date:today});
                          $db.set( "allSentMailLogs", {"sentMailLogs":mails}).then (
                            function(data) { console.log("updated sent mails at db",data);},
                            function(error) <span class="fstat-no" title="function not covered" >{ <span class="cstat-no" title="statement not covered" >console.log("failed to update sent mails at db " , error); </span>})</span>;
                        },
                        function(error) {
                          let today = new Date().toLocaleString();
                          console.log("first sent mail error ", error , savedRolesTemplate[matchedRoleIndex].role);
                          $db.set( "allSentMailLogs",{"sentMailLogs":[{ role:savedRolesTemplate[matchedRoleIndex].role ,email:payload.data.actor.email,status_msg:"Email sent successfully",  sent:true ,date:today}]}).then (
                            function(data) { console.log("sent mails db initialised",data); },
                            function(error) <span class="fstat-no" title="function not covered" >{ <span class="cstat-no" title="statement not covered" >console.log("failed to initalise sent mails db" , error); </span>})</span>
                        });
                      }
                      else{
                        console.log("error is failed to send mail ", error.response);
                        $db.get("allFailedMailLogs").then (
                          function(data) <span class="fstat-no" title="function not covered" >{</span>
                          let mails = <span class="cstat-no" title="statement not covered" >data.failedMailLogs;</span>
                          let today = <span class="cstat-no" title="statement not covered" >new Date().toLocaleString();</span>
<span class="cstat-no" title="statement not covered" >                          mails.push({ role:savedRolesTemplate[matchedRoleIndex].role ,email:payload.data.actor.email,status_msg:error.response,  sent:false ,date:today});</span>
<span class="cstat-no" title="statement not covered" >                          $db.set( "allFailedMailLogs", {"failedMailLogs":mails}).then (</span>
                            function(data) <span class="fstat-no" title="function not covered" >{ <span class="cstat-no" title="statement not covered" >console.log("updated failed mails at db",data);}</span>,</span>
                            function(error) <span class="fstat-no" title="function not covered" >{ <span class="cstat-no" title="statement not covered" >console.log("failed to update failed mails at db " , error); </span>})</span>;
                        },
                        function(err) {
                          console.log("error is ",err);
                          let today = new Date().toLocaleString();
                          $db.set( "allFailedMailLogs",{"failedMailLogs":[{role:newHireDesignation ,email:payload.data.actor.email,status_msg:error.response,  sent:false ,date:today}]}).then (
                            function(data) { console.log("failed mails db initialised",data); },
                            function(error) <span class="fstat-no" title="function not covered" >{ <span class="cstat-no" title="statement not covered" >console.log("failed to initalise failed mails db" , error); </span>})</span>
                        });
                      }
                    })
                }
                else{
                  //template not found case
<span class="cstat-no" title="statement not covered" >                  $db.get("allFailedMailLogs").then (</span>
                    function(data) <span class="fstat-no" title="function not covered" >{</span>
                    let mails = <span class="cstat-no" title="statement not covered" >data.failedMailLogs;</span>
                    let today = <span class="cstat-no" title="statement not covered" >new Date().toLocaleString();</span>
<span class="cstat-no" title="statement not covered" >                    mails.push({ role:newHireDesignation ,email:payload.data.actor.email,status_msg:"Template not found",  sent:false ,date:today});</span>
<span class="cstat-no" title="statement not covered" >                    $db.set( "allFailedMailLogs", {"failedMailLogs":mails}).then (</span>
                      function(data) <span class="fstat-no" title="function not covered" >{ <span class="cstat-no" title="statement not covered" >console.log("no template found at db",data);}</span>,</span>
                      function(error) <span class="fstat-no" title="function not covered" >{ <span class="cstat-no" title="statement not covered" >console.log("failed to update failed mails at db at template nt found " , error); </span>})</span>;
                  },
                  function(error) <span class="fstat-no" title="function not covered" >{</span>
                    let today = <span class="cstat-no" title="statement not covered" >new Date().toLocaleString();</span>
<span class="cstat-no" title="statement not covered" >                    console.log("first failed mails ", error);</span>
<span class="cstat-no" title="statement not covered" >                    $db.set( "allFailedMailLogs",{"failedMailLogs":[{ role:newHireDesignation  ,email:payload.data.actor.email,status_msg:"Template not found",  sent:false ,date:today}]}).then (</span>
                      function(data) <span class="fstat-no" title="function not covered" >{ <span class="cstat-no" title="statement not covered" >console.log("failed mails db initialised",data); </span>},</span>
                      function(error) <span class="fstat-no" title="function not covered" >{ <span class="cstat-no" title="statement not covered" >console.log("failed to initalise failed mails db" , error); </span>})</span>
                  });
                }
              //}
          },
          function(error) <span class="fstat-no" title="function not covered" >{</span>
<span class="cstat-no" title="statement not covered" >              console.log("failed to get saved templates ", error);</span>
          });
       
    }
};
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Wed Mar 09 2022 22:36:21 GMT+0530 (India Standard Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
